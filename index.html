<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Tinemu Data Bocor</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>ğŸ” Tinemu Data Bocor</h2>

    <div class="vertical-divider" aria-hidden="true"></div>

    <div class="row">
      <!-- Left: Input -->
      <div class="col-12 col-md-6">
        <p class="col-note">Masukkan data di kolom ini. Isi minimal satu dari: Email, Nomor HP, IP atau unggah Foto KTP.</p>
        <div class="section">
          <h5 class="mb-3 text-primary">Input</h5>
          <label for="email">ğŸ“§ Email:</label>
          <input type="text" id="email" placeholder="contoh@email.com">

          <label for="phone">ğŸ“± Nomor HP:</label>
          <input type="text" id="phone" placeholder="08xxxxxxxxxx">

          <label for="ip">ğŸŒ IP Address:</label>
          <input type="text" id="ip" placeholder="192.168.1.1">

          <!-- NIK input removed: NIK will be read only from uploaded KTP image -->

          <label for="ktp">ğŸ–¼ï¸ Upload Foto KTP:</label>
          <input type="file" id="ktp" accept="image/*">

          <div class="actions">
            <button class="btn-primary" onclick="checkData()">ğŸ” Periksa Risiko</button>
            <button class="btn-secondary" onclick="refreshForm()">ğŸ”„ Reset</button>
          </div>
        </div>
      </div>

      <!-- Right: Output -->
      <div class="col-12 col-md-6">
        <div class="section">
          <h5 class="mb-3 text-primary">Hasil Pengecekan</h5>
          <div id="output" class="result"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function refreshForm() {
      document.getElementById("email").value = "";
      document.getElementById("phone").value = "";
      document.getElementById("ip").value = "";
      document.getElementById("ktp").value = "";
      document.getElementById("output").innerText = "";
    }

    function validateNIK(nik) {
      if (!/^\d{16}$/.test(nik)) return "âŒ Format NIK tidak valid (harus 16 digit angka)";
      const kodeWilayah = nik.slice(0, 6);
      const tanggalLahir = nik.slice(6, 12);
      const genderCode = parseInt(tanggalLahir.slice(0, 2), 10);
      const jenisKelamin = genderCode > 40 ? "Perempuan" : "Laki-laki";
      const tanggal = genderCode > 40 ? genderCode - 40 : genderCode;
      const bulan = tanggalLahir.slice(2, 4);
      const tahun = tanggalLahir.slice(4, 6);
      return `âœ… Format NIK valid\nWilayah: ${kodeWilayah}\nJenis Kelamin: ${jenisKelamin}\nTanggal Lahir: ${tanggal}-${bulan}-19${tahun}`;
    }

    function getPhoneRisk(normalized) {
      if (normalized === "081234567890") return "Tinggi â€“ nomor dummy umum";
      if (normalized.length < 10) return "Tinggi â€“ nomor terlalu pendek";
      if (/^08\d{4,}$/.test(normalized) && /^(\d)\1{5,}$/.test(normalized.slice(3))) return "Tinggi â€“ pola angka berulang";
      const prefix = normalized.slice(0, 4);
      const riskMap = {
        "0811": "Sedang â€“ Telkomsel", "0812": "Sedang â€“ Telkomsel", "0813": "Sedang â€“ Telkomsel",
        "0821": "Sedang â€“ Telkomsel", "0822": "Sedang â€“ Telkomsel", "0823": "Sedang â€“ Telkomsel",
        "0852": "Sedang â€“ Telkomsel", "0853": "Sedang â€“ Telkomsel",
        "0814": "Sedang â€“ Indosat", "0815": "Sedang â€“ Indosat", "0816": "Sedang â€“ Indosat",
        "0855": "Sedang â€“ Indosat", "0856": "Sedang â€“ Indosat", "0857": "Sedang â€“ Indosat", "0858": "Sedang â€“ Indosat",
        "0817": "Lemah â€“ XL", "0818": "Lemah â€“ XL", "0819": "Lemah â€“ XL", "0859": "Lemah â€“ XL", "0877": "Lemah â€“ XL", "0878": "Lemah â€“ XL",
        "0831": "Lemah â€“ Axis", "0832": "Lemah â€“ Axis", "0833": "Lemah â€“ Axis", "0838": "Lemah â€“ Axis",
        "0895": "Sedang â€“ Tri", "0896": "Sedang â€“ Tri", "0897": "Sedang â€“ Tri", "0898": "Sedang â€“ Tri", "0899": "Sedang â€“ Tri",
        "0881": "Tinggi â€“ Smartfren", "0882": "Tinggi â€“ Smartfren", "0883": "Tinggi â€“ Smartfren", "0884": "Tinggi â€“ Smartfren",
        "0885": "Tinggi â€“ Smartfren", "0886": "Tinggi â€“ Smartfren", "0887": "Tinggi â€“ Smartfren", "0888": "Tinggi â€“ Smartfren", "0889": "Tinggi â€“ Smartfren"
      };
      return riskMap[prefix] || "Tidak dapat ditentukan â€“ prefix tidak dikenali";
    }

    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return String(unsafe).replace(/[&<>'"]/g, function (m) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#039;','"':'&quot;'})[m];
      });
    }

    async function checkData() {
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const ip = document.getElementById("ip").value.trim();
      // NIK is obtained only from uploaded KTP via OCR
      const ktpFile = document.getElementById("ktp").files[0];

      let html = '';
      const emailRegex = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
      const phoneRegex = /^(\+62|62|0)?8[1-9][0-9]{6,10}$/;
      const ipRegex = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;

      // Email -> clickable HIBP link
      if (email) {
        if (emailRegex.test(email)) {
          const href = 'https://haveibeenpwned.com/?email=' + encodeURIComponent(email);
          html += `<p>âœ… Email valid: <strong>${escapeHtml(email)}</strong><br>ğŸ”— <a href="${href}" target="_blank" rel="noopener noreferrer">Cek di HaveIBeenPwned</a></p>`;
        } else {
          html += `<p>âŒ Format email tidak valid: <strong>${escapeHtml(email)}</strong></p>`;
        }
      }

      // Phone
      if (phone) {
        const normalized = phone.replace(/^(\+62|62)/, '0');
        if (phoneRegex.test(phone)) {
          html += `<p>âœ… Nomor HP valid: <strong>${escapeHtml(phone)}</strong><br>Risiko: ${escapeHtml(getPhoneRisk(normalized))}</p>`;
        } else {
          html += `<p>âŒ Nomor HP tidak valid: <strong>${escapeHtml(phone)}</strong></p>`;
        }
      }

      // IP
      if (ip) {
        html += ipRegex.test(ip)
          ? `<p>âœ… IP Address valid: <strong>${escapeHtml(ip)}</strong><br>Risiko: Rendah</p>`
          : `<p>âŒ IP Address tidak valid: <strong>${escapeHtml(ip)}</strong></p>`;
      }

      // NIK detection will be done via OCR from uploaded KTP
      let nikFound = '';

      // OCR from KTP if uploaded and no valid input NIK yet
      if (ktpFile && !nikFound) {
        html += `<p>ğŸ“ File KTP terdeteksi: <strong>${escapeHtml(ktpFile.name)}</strong><br>â³ Memindai teks dari gambar...</p>`;
        const ktpUrl = URL.createObjectURL(ktpFile);
        try {
          const { data: { text } } = await Tesseract.recognize(ktpUrl, 'ind');
          // search for 16-digit NIK
          const nikMatch = text.match(/\b\d{16}\b/);
          const nameMatch = text.match(/(?<=Nama\s?:\s?).+/i);

          // Jika salah satu atau kedua ditemukan, tampilkan apa yang berhasil dikenali.
          if (nikMatch || nameMatch) {
            if (nikMatch) {
              nikFound = nikMatch[0];
              const dukUrl = 'https://dukcapil.kemendagri.go.id/?nik=' + encodeURIComponent(nikFound);
              html += `<p>ğŸ“„ Hasil OCR:<br>NIK: <strong>${escapeHtml(nikFound)}</strong> â€” ğŸ”— <a href="${dukUrl}" target="_blank" rel="noopener noreferrer">Cek di Dukcapil</a></p>`;
            } else {
              html += `<p>ğŸ“„ Hasil OCR: NIK tidak ditemukan.</p>`;
            }
            html += `<p>Nama: ${escapeHtml(nameMatch ? nameMatch[0].trim() : 'Tidak ditemukan')}</p>`;
          } else {
            // Jika kedua-duanya tidak ditemukan, tampilkan pesan validasi khusus
            html += `<p>ğŸ“„ Hasil OCR: NIK dan Nama tidak ditemukan.</p>`;
            html += `<p style="color:#b00; font-weight:bold;">data tidak valid, mohon unggah data lain.</p>`;
          }
        } catch (err) {
          html += `<p>âŒ Gagal melakukan OCR pada KTP: ${escapeHtml(err.message || String(err))}</p>`;
        } finally {
          URL.revokeObjectURL(ktpUrl);
        }
      }

      // If no NIK provided and no KTP uploaded, show warning
      if (!nikFound && !ktpFile) {
        html += `<p style="color:#b00; font-weight:bold;">data tidak valid, mohon unggah data lain.</p>`;
      }

      document.getElementById("output").innerHTML = html || '<p>â„¹ï¸ Tidak ada masukan yang valid untuk diperiksa.</p>';
    }
  </script>
</body>
</html>