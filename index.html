<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Tinemu Data Bocor</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>ğŸ” Tinemu Data Bocor</h2>

    <div class="vertical-divider" aria-hidden="true"></div>

    <div class="row">
      <!-- Left: Input -->
      <div class="col-12 col-md-6">
        <p class="col-note">Masukkan data di kolom ini. Isi minimal satu dari: Email, Nomor HP, IP atau unggah Foto KTP.</p>
        <div class="section">
          <h5 class="mb-3 text-primary">Input</h5>
          <label for="email">ğŸ“§ Email:</label>
          <input type="text" id="email" placeholder="contoh@email.com">

          <label for="phone">ğŸ“± Nomor HP:</label>
          <input type="text" id="phone" placeholder="08xxxxxxxxxx">

          <label for="ip">ğŸŒ IP Address:</label>
          <input type="text" id="ip" placeholder="192.168.1.1">

          <!-- NIK input removed: NIK will be read only from uploaded KTP image -->

          <label for="ktp">ğŸ–¼ï¸ Upload Foto KTP:</label>
          <input type="file" id="ktp" accept="image/*" onchange="handleKtpUpload(event)">

          <div class="actions">
            <button class="btn-primary" onclick="checkData()">ğŸ” Periksa Risiko</button>
            <button class="btn-secondary" onclick="refreshForm()">ğŸ”„ Reset</button>
          </div>
        </div>
      </div>

      <!-- Right: Output -->
      <div class="col-12 col-md-6">
        <div class="section">
          <h5 class="mb-3 text-primary">Hasil Pengecekan</h5>
          <div id="output" class="result"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function refreshForm() {
      document.getElementById("email").value = "";
      document.getElementById("phone").value = "";
      document.getElementById("ip").value = "";
      document.getElementById("ktp").value = "";
      document.getElementById("output").innerText = "";
    }

    /* --- External scanning + parsing helpers --- */
    async function handleKtpUpload(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) return;
      const output = document.getElementById('output');
      output.innerHTML = `<p>ğŸ“ File terunggah: <strong>${escapeHtml(file.name)}</strong><br>â³ Memindai OCR lokal...</p>`;

        try {
          const ktpUrl = URL.createObjectURL(file);
          const preprocessed = await preprocessImageFile(file, 1200);
          const worker = await getOcrWorker();
          const { data: { text } } = await worker.recognize(preprocessed);
          const parsed = parseKtpText(text || '');
          window.lastKtpParse = Object.assign({ fileName: file.name }, parsed);
          output.innerHTML = buildKtpHtmlFromParsed(parsed);
          URL.revokeObjectURL(ktpUrl);
        } catch (err) {
          console.error('OCR lokal gagal:', err);
          // Jangan tampilkan pesan kegagalan teknis; tunjukkan hasil kosong sehingga
          // hanya akan muncul pesan 'data yang diunggah tidak valid' bila nama dan NIK benar-benar tidak ditemukan
          const parsed = { nik: '', name: '', tempat: '', tgl: '', address: '' };
          window.lastKtpParse = Object.assign({ fileName: file.name }, parsed);
          output.innerHTML = buildKtpHtmlFromParsed(parsed);
      }
    }

    /* performExternalScan removed â€” using local Tesseract OCR only */

    function parseKtpText(text) {
      const normalized = (text || '').replace(/\r/g, '\n');
      const nikMatch = normalized.match(/\b\d{16}\b/);
      const nik = nikMatch ? nikMatch[0] : '';

      let name = '';
      const nameMatch = normalized.match(/Nama\s*[:\-]?\s*(.+)/i);
      if (nameMatch) name = nameMatch[1].split(/\n|\r/)[0].trim();

      let address = '';
      const addrMatch = normalized.match(/Alamat\s*[:\-]?\s*([\s\S]{5,200}?)(?=\n\s*(?:Nama|Tempat|Tempat\/Tgl|Tanggal|NIK|$))/i);
      if (addrMatch) address = addrMatch[1].trim().replace(/\n+/g, ' ');

      let tempat = '';
      let tgl = '';
      const tpltglMatch = normalized.match(/Tempat\s*\/?\s*Tgl(?:\s*Lahir)?\s*[:\-]?\s*(.+)/i);
      if (tpltglMatch) {
        const v = tpltglMatch[1].split(/\n/)[0].trim();
        const parts = v.split(',');
        if (parts.length >= 2) {
          tempat = parts[0].trim();
          tgl = parts.slice(1).join(',').trim();
        } else {
          const dateMatch = v.match(/\b(\d{1,2}[-\/\.\s]\d{1,2}[-\/\.\s]\d{2,4})\b/);
          if (dateMatch) {
            tgl = dateMatch[1];
            tempat = v.replace(dateMatch[0], '').trim().replace(/[,\-]$/,'').trim();
          } else {
            tempat = v;
          }
        }
      } else {
        const tempatMatch = normalized.match(/Tempat\s*Lahir\s*[:\-]?\s*(.+)/i);
        const tanggalMatch = normalized.match(/Tanggal\s*Lahir\s*[:\-]?\s*(.+)/i);
        if (tempatMatch) tempat = tempatMatch[1].split(/\n/)[0].trim();
        if (tanggalMatch) tgl = tanggalMatch[1].split(/\n/)[0].trim();
      }

      return { nik, name, tempat, tgl, address };
    }

    function buildKtpHtmlFromParsed(parsed) {
      const { nik, name, tempat, tgl, address } = parsed || {};
      let out = '<h6>ğŸ“„ Hasil Pemindaian KTP</h6>';
      if (nik || name || tempat || tgl || address) {
        if (nik) out += `<p>NIK: <strong>${escapeHtml(nik)}</strong> â€” ğŸ”— <a href="https://dukcapil.kemendagri.go.id/?nik=${encodeURIComponent(nik)}" target="_blank" rel="noopener noreferrer">Cek di Dukcapil</a></p>`;
        if (name) out += `<p>Nama: <strong>${escapeHtml(name)}</strong></p>`;
        if (tempat || tgl) out += `<p>Tempat/Tgl Lahir: <strong>${escapeHtml((tempat || '') + (tempat && tgl ? ', ' : '') + (tgl || ''))}</strong></p>`;
        if (address) out += `<p>Alamat: ${escapeHtml(address)}</p>`;
      } else {
        out += `<p style="color:#b00; font-weight:bold;">data yang diunggah tidak valid, mohon unggah data lain.</p>`;
      }
      return out;
    }

    // --- Faster OCR helpers: reuse worker + preprocess image ---
    async function getOcrWorker() {
      if (window._ocrWorker) return window._ocrWorker;
      const worker = Tesseract.createWorker({
        logger: m => {
          /* optional: console.log(m); */
        }
      });
      await worker.load();
      await worker.loadLanguage('ind');
      await worker.initialize('ind');
      // Use a faster PSM (assume blocks of text) and reduce some overhead
      await worker.setParameters({ tessedit_pageseg_mode: '6' });
      window._ocrWorker = worker;
      return worker;
    }

    // Resize file -> dataURL (image) to smaller width to speed recognition
    function preprocessImageFile(file, maxWidth) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.onload = () => {
          const ratio = img.width && img.width > maxWidth ? maxWidth / img.width : 1;
          const canvas = document.createElement('canvas');
          canvas.width = Math.round(img.width * ratio);
          canvas.height = Math.round(img.height * ratio);
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          canvas.toBlob(blob => {
            URL.revokeObjectURL(url);
            const dataUrl = URL.createObjectURL(blob);
            resolve(dataUrl);
          }, 'image/jpeg', 0.8);
        };
        img.onerror = e => { URL.revokeObjectURL(url); reject(e); };
        img.src = url;
      });
    }

    // When we already have a blob (from fetch), similar helper
    function preprocessImageBlob(blob, maxWidth) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const url = URL.createObjectURL(blob);
        img.onload = () => {
          const ratio = img.width && img.width > maxWidth ? maxWidth / img.width : 1;
          const canvas = document.createElement('canvas');
          canvas.width = Math.round(img.width * ratio);
          canvas.height = Math.round(img.height * ratio);
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          canvas.toBlob(b => {
            URL.revokeObjectURL(url);
            const dataUrl = URL.createObjectURL(b);
            resolve(dataUrl);
          }, 'image/jpeg', 0.8);
        };
        img.onerror = e => { URL.revokeObjectURL(url); reject(e); };
        img.src = url;
      });
    }

    function validateNIK(nik) {
      if (!/^\d{16}$/.test(nik)) return "âŒ Format NIK tidak valid (harus 16 digit angka)";
      const kodeWilayah = nik.slice(0, 6);
      const tanggalLahir = nik.slice(6, 12);
      const genderCode = parseInt(tanggalLahir.slice(0, 2), 10);
      const jenisKelamin = genderCode > 40 ? "Perempuan" : "Laki-laki";
      const tanggal = genderCode > 40 ? genderCode - 40 : genderCode;
      const bulan = tanggalLahir.slice(2, 4);
      const tahun = tanggalLahir.slice(4, 6);
      return `âœ… Format NIK valid\nWilayah: ${kodeWilayah}\nJenis Kelamin: ${jenisKelamin}\nTanggal Lahir: ${tanggal}-${bulan}-19${tahun}`;
    }

    function getPhoneRisk(normalized) {
      if (normalized === "081234567890") return "Tinggi â€“ nomor dummy umum";
      if (normalized.length < 10) return "Tinggi â€“ nomor terlalu pendek";
      if (/^08\d{4,}$/.test(normalized) && /^(\d)\1{5,}$/.test(normalized.slice(3))) return "Tinggi â€“ pola angka berulang";
      const prefix = normalized.slice(0, 4);
      const riskMap = {
        "0811": "Sedang â€“ Telkomsel", "0812": "Sedang â€“ Telkomsel", "0813": "Sedang â€“ Telkomsel",
        "0821": "Sedang â€“ Telkomsel", "0822": "Sedang â€“ Telkomsel", "0823": "Sedang â€“ Telkomsel",
        "0852": "Sedang â€“ Telkomsel", "0853": "Sedang â€“ Telkomsel",
        "0814": "Sedang â€“ Indosat", "0815": "Sedang â€“ Indosat", "0816": "Sedang â€“ Indosat",
        "0855": "Sedang â€“ Indosat", "0856": "Sedang â€“ Indosat", "0857": "Sedang â€“ Indosat", "0858": "Sedang â€“ Indosat",
        "0817": "Lemah â€“ XL", "0818": "Lemah â€“ XL", "0819": "Lemah â€“ XL", "0859": "Lemah â€“ XL", "0877": "Lemah â€“ XL", "0878": "Lemah â€“ XL",
        "0831": "Lemah â€“ Axis", "0832": "Lemah â€“ Axis", "0833": "Lemah â€“ Axis", "0838": "Lemah â€“ Axis",
        "0895": "Sedang â€“ Tri", "0896": "Sedang â€“ Tri", "0897": "Sedang â€“ Tri", "0898": "Sedang â€“ Tri", "0899": "Sedang â€“ Tri",
        "0881": "Tinggi â€“ Smartfren", "0882": "Tinggi â€“ Smartfren", "0883": "Tinggi â€“ Smartfren", "0884": "Tinggi â€“ Smartfren",
        "0885": "Tinggi â€“ Smartfren", "0886": "Tinggi â€“ Smartfren", "0887": "Tinggi â€“ Smartfren", "0888": "Tinggi â€“ Smartfren", "0889": "Tinggi â€“ Smartfren"
      };
      return riskMap[prefix] || "Tidak dapat ditentukan â€“ prefix tidak dikenali";
    }

    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return String(unsafe).replace(/[&<>'"]/g, function (m) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#039;','"':'&quot;'})[m];
      });
    }

    async function checkData() {
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const ip = document.getElementById("ip").value.trim();
      // NIK is obtained only from uploaded KTP via OCR
      const ktpFile = document.getElementById("ktp").files[0];

      let html = '';
      const emailRegex = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
      const phoneRegex = /^(\+62|62|0)?8[1-9][0-9]{6,10}$/;
      const ipRegex = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;

      // Email -> clickable HIBP link
      if (email) {
        if (emailRegex.test(email)) {
          const href = 'https://haveibeenpwned.com/?email=' + encodeURIComponent(email);
          html += `<p>âœ… Email valid: <strong>${escapeHtml(email)}</strong><br>ğŸ”— <a href="${href}" target="_blank" rel="noopener noreferrer">Cek di HaveIBeenPwned</a></p>`;
        } else {
          html += `<p>âŒ Email tidak valid: <strong>${escapeHtml(email)}</strong></p>`;
        }
      }

      // Phone
      if (phone) {
        const normalized = phone.replace(/^(\+62|62)/, '0');
        if (phoneRegex.test(phone)) {
          html += `<p>âœ… Nomor HP valid: <strong>${escapeHtml(phone)}</strong><br>Risiko: ${escapeHtml(getPhoneRisk(normalized))}</p>`;
        } else {
          html += `<p>âŒ Nomor HP tidak valid: <strong>${escapeHtml(phone)}</strong></p>`;
        }
      }

      // IP
      if (ip) {
        html += ipRegex.test(ip)
          ? `<p>âœ… IP Address valid: <strong>${escapeHtml(ip)}</strong><br>Risiko: Rendah</p>`
          : `<p>âŒ IP Address tidak valid: <strong>${escapeHtml(ip)}</strong></p>`;
      }

      // NIK detection will be done via OCR from uploaded KTP
      let nikFound = '';

      // Jika file sudah diunggah, gunakan hasil pemindaian yang mungkin telah disimpan
      if (ktpFile) {
        html += `<p>ğŸ“ File KTP terdeteksi: <strong>${escapeHtml(ktpFile.name)}</strong><br>â³ Memindai teks dari gambar...</p>`;
        try {
          if (window.lastKtpParse && window.lastKtpParse.fileName === ktpFile.name) {
            const parsed = window.lastKtpParse;
            if (parsed.nik) nikFound = parsed.nik;
            html += buildKtpHtmlFromParsed(parsed);
          } else {
            // Jika tidak ada hasil dari handler upload, gunakan OCR lokal sebagai fallback
            const ktpUrl = URL.createObjectURL(ktpFile);
            try {
              // Use preprocessed image + reused worker to speed up
              const blob = await fetch(ktpUrl).then(r => r.blob());
              const preprocessed = await preprocessImageBlob(blob, 1200);
              const worker = await getOcrWorker();
              const { data: { text } } = await worker.recognize(preprocessed);
              const parsed = parseKtpText(text || '');
              if (parsed.nik) nikFound = parsed.nik;
              html += buildKtpHtmlFromParsed(parsed);
            } catch (err) {
              console.error('OCR pada KTP gagal:', err);
              // Simpan hasil kosong sehingga UI hanya menampilkan 'data tidak valid' bila
              // NIK & Nama memang tidak ditemukan
              const parsed = { nik: '', name: '', tempat: '', tgl: '', address: '' };
              window.lastKtpParse = Object.assign({ fileName: ktpFile.name }, parsed);
              html += buildKtpHtmlFromParsed(parsed);
            } finally {
              URL.revokeObjectURL(ktpUrl);
            }
          }
        } catch (err) {
          console.error('OCR proses gagal:', err);
          const parsed = { nik: '', name: '', tempat: '', tgl: '', address: '' };
          window.lastKtpParse = Object.assign({ fileName: ktpFile.name || '' }, parsed);
          html += buildKtpHtmlFromParsed(parsed);
        }
      }

      // Jika tidak ada masukan sama sekali tampilkan info.
      if (!html && !ktpFile) {
        html = '<p>â„¹ï¸ Tidak ada masukan yang valid untuk diperiksa. Isi salah satu kolom atau unggah Foto KTP.</p>';
      }

      document.getElementById("output").innerHTML = html || '<p>â„¹ï¸ Tidak ada masukan yang valid untuk diperiksa.</p>';
    }
  </script>
</body>
</html>